# ===============================
# è§†é¢‘å·¥åŠ - GitHub Actions äº‘æ‰“åŒ…é…ç½®
# ===============================
# push æ—¶è‡ªåŠ¨è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
# ===============================

name: Flutter Build APK
on:
  push:
    branches: [main, master]  # æ¨é€åˆ°ä¸»åˆ†æ”¯è‡ªåŠ¨æ„å»º
  workflow_dispatch:           # æ‰‹åŠ¨è§¦å‘

# ğŸ‘‡ åœ¨è¿™é‡Œä¿®æ”¹ APP ä¸­æ–‡å
env:
  APP_NAME: "è§†é¢‘å·¥åŠ"
  FILE_NAME: "VideoCutter"

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      LANG: "en_US.UTF-8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. é…ç½® Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 2. é…ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 3. ä¸‹è½½ FFmpeg äºŒè¿›åˆ¶æ–‡ä»¶ (ä½¿ç”¨ apt å®‰è£…åæå–é™æ€ç‰ˆæœ¬)
      - name: Download FFmpeg Binary
        run: |
          echo "ğŸ“¦ å‡†å¤‡ FFmpeg äºŒè¿›åˆ¶æ–‡ä»¶..."
          mkdir -p assets/bin
          
          # æ–¹æ¡ˆ: ä» GitHub å¯é æºä¸‹è½½é¢„ç¼–è¯‘çš„ Android arm64 FFmpeg
          # ä½¿ç”¨ writingminds/ffmpeg-android é¢„ç¼–è¯‘ç‰ˆæœ¬
          echo "ğŸ“¥ ä¸‹è½½ FFmpeg for Android arm64..."
          
          # å°è¯•å¤šä¸ªå¯é æº
          FFMPEG_URL="https://github.com/AerunWreb/AerunWeb/releases/download/ffmpeg/ffmpeg-android-arm64.zip"
          BACKUP_URL="https://github.com/AerunWeeb/AerunWeb/releases/download/ffmpeg/ffmpeg"
          
          # å…ˆå°è¯•ä¸‹è½½ zip åŒ…
          if curl -L -f -o ffmpeg.zip "$FFMPEG_URL" 2>/dev/null; then
            echo "âœ… ä»ä¸»æºä¸‹è½½æˆåŠŸ"
            unzip -o ffmpeg.zip -d assets/bin/ || true
          fi
          
          # å¦‚æœæ²¡æœ‰ ffmpeg æ–‡ä»¶ï¼Œç›´æ¥ä¸‹è½½å•æ–‡ä»¶
          if [ ! -f "assets/bin/ffmpeg" ]; then
            echo "ğŸ“¥ å°è¯•ç›´æ¥ä¸‹è½½ ffmpeg äºŒè¿›åˆ¶..."
            curl -L -f -o assets/bin/ffmpeg "$BACKUP_URL" 2>/dev/null || true
          fi
          
          # å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä½¿ç”¨ç³»ç»Ÿçš„é™æ€æ„å»ºè„šæœ¬åˆ›å»ºå ä½ç¬¦
          # å®é™…ä¸Šæˆ‘ä»¬ä¼šç”¨ termux-exec æ–¹æ¡ˆ
          if [ ! -f "assets/bin/ffmpeg" ]; then
            echo "ğŸ“¥ åˆ›å»ºå ä½ç¬¦ï¼ˆè¿è¡Œæ—¶ä»è®¾å¤‡è·å–ï¼‰..."
            echo "placeholder" > assets/bin/ffmpeg
            echo "placeholder" > assets/bin/ffprobe
          fi
          
          chmod +x assets/bin/* 2>/dev/null || true
          echo "âœ… FFmpeg å‡†å¤‡å®Œæˆ"
          ls -la assets/bin/

      # 4. ç”Ÿæˆ Android å·¥ç¨‹éª¨æ¶
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            echo "ğŸ“¦ ç”Ÿæˆ Android å·¥ç¨‹..."
            flutter create . --platforms android --project-name video_cutter
          fi

      # 5. ä¿®æ”¹ APP ä¸­æ–‡å
      - name: Change App Name
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          python3 -c "
          import re
          with open('$MANIFEST', 'r', encoding='utf-8') as f:
              content = f.read()
          new_content = re.sub(r'android:label=\"[^\"]*\"', 'android:label=\"${{ env.APP_NAME }}\"', content)
          with open('$MANIFEST', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "
          echo "âœ… App name set to: ${{ env.APP_NAME }}"

      # 6. ç¯å¢ƒä¿®å¤ 
      - name: Fix Android Environment
        run: |
          echo "ğŸ”§ Fixing Kotlin to 1.9.0..."
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          echo "ğŸ”§ Setting MinSDK to 21..."
          sed -i 's/minSdkVersion.*/minSdkVersion 21/g' android/app/build.gradle

      # 7. åˆ›å»º Kotlin FFmpeg æœåŠ¡ (ä½¿ç”¨ SAF + MediaStore æ–¹æ¡ˆ)
      - name: Create Kotlin FFmpeg Bridge
        run: |
          KOTLIN_DIR="android/app/src/main/kotlin/com/example/video_cutter"
          mkdir -p "$KOTLIN_DIR"
          
          cat > "$KOTLIN_DIR/MainActivity.kt" << 'KOTLIN_EOF'
          package com.example.video_cutter

          import android.os.Bundle
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import java.io.FileOutputStream
          import java.io.BufferedReader

          class MainActivity : FlutterActivity() {
              private val CHANNEL = "com.videocutter/ffmpeg"
              private var ffmpegPath: String? = null
              private var ffprobePath: String? = null

              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  
                  initFFmpegBinary()
                  
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result ->
                      when (call.method) {
                          "cutVideo" -> {
                              val input = call.argument<String>("input") ?: ""
                              val output = call.argument<String>("output") ?: ""
                              val start = call.argument<String>("start") ?: "0"
                              val end = call.argument<String>("end") ?: "10"
                              
                              Thread {
                                  val success = runFFmpeg(listOf(
                                      "-y", "-ss", start, "-to", end,
                                      "-i", input, "-c", "copy",
                                      "-avoid_negative_ts", "1", output
                                  ))
                                  runOnUiThread { result.success(success) }
                              }.start()
                          }
                          "stitchVideos" -> {
                              val inputs = call.argument<List<String>>("inputs") ?: listOf()
                              val output = call.argument<String>("output") ?: ""
                              
                              Thread {
                                  val success = stitchVideos(inputs, output)
                                  runOnUiThread { result.success(success) }
                              }.start()
                          }
                          "analyzeVideo" -> {
                              val path = call.argument<String>("path") ?: ""
                              Thread {
                                  val info = analyzeVideo(path)
                                  runOnUiThread { result.success(info) }
                              }.start()
                          }
                          "isReady" -> result.success(ffmpegPath != null && File(ffmpegPath!!).exists() && File(ffmpegPath!!).length() > 1000)
                          else -> result.notImplemented()
                      }
                  }
              }

              private fun initFFmpegBinary() {
                  try {
                      val binDir = File(filesDir, "bin")
                      binDir.mkdirs()
                      
                      listOf("ffmpeg", "ffprobe").forEach { name ->
                          val outFile = File(binDir, name)
                          // åªæœ‰å½“æ–‡ä»¶ä¸å­˜åœ¨æˆ–å¤ªå°æ—¶æ‰å¤åˆ¶
                          if (!outFile.exists() || outFile.length() < 1000) {
                              try {
                                  assets.open("bin/$name").use { input ->
                                      FileOutputStream(outFile).use { output ->
                                          input.copyTo(output)
                                      }
                                  }
                                  outFile.setExecutable(true)
                              } catch (e: Exception) {
                                  // å¦‚æœ assets ä¸­æ²¡æœ‰ï¼Œå°è¯•ä½¿ç”¨ termux çš„ ffmpeg
                                  val termuxPath = "/data/data/com.termux/files/usr/bin/$name"
                                  if (File(termuxPath).exists()) {
                                      File(termuxPath).copyTo(outFile, overwrite = true)
                                      outFile.setExecutable(true)
                                  }
                              }
                          }
                          if (name == "ffmpeg") ffmpegPath = outFile.absolutePath
                          if (name == "ffprobe") ffprobePath = outFile.absolutePath
                      }
                  } catch (e: Exception) {
                      e.printStackTrace()
                  }
              }

              private fun runFFmpeg(args: List<String>): Boolean {
                  val path = ffmpegPath ?: return false
                  if (!File(path).exists() || File(path).length() < 1000) return false
                  
                  return try {
                      val cmd = listOf(path) + args
                      val process = ProcessBuilder(cmd)
                          .redirectErrorStream(true)
                          .start()
                      
                      // è¯»å–è¾“å‡ºé˜²æ­¢é˜»å¡
                      process.inputStream.bufferedReader().use { it.readText() }
                      val exitCode = process.waitFor()
                      exitCode == 0
                  } catch (e: Exception) {
                      e.printStackTrace()
                      false
                  }
              }

              private fun stitchVideos(inputs: List<String>, output: String): Boolean {
                  val path = ffmpegPath ?: return false
                  if (!File(path).exists() || File(path).length() < 1000) return false
                  
                  return try {
                      val listFile = File(cacheDir, "concat_${System.currentTimeMillis()}.txt")
                      listFile.writeText(inputs.joinToString("\n") { "file '$it'" })
                      
                      val cmd = listOf(path, "-y", "-f", "concat", "-safe", "0", 
                                       "-i", listFile.absolutePath, "-c", "copy", output)
                      val process = ProcessBuilder(cmd)
                          .redirectErrorStream(true)
                          .start()
                      
                      process.inputStream.bufferedReader().use { it.readText() }
                      val exitCode = process.waitFor()
                      listFile.delete()
                      exitCode == 0
                  } catch (e: Exception) {
                      e.printStackTrace()
                      false
                  }
              }

              private fun analyzeVideo(path: String): Map<String, Any>? {
                  val probePath = ffprobePath ?: return null
                  if (!File(probePath).exists() || File(probePath).length() < 1000) return null
                  
                  return try {
                      val cmd = listOf(probePath, "-v", "error", "-select_streams", "v:0",
                          "-show_entries", "stream=width,height,codec_name,r_frame_rate:format=duration",
                          "-of", "csv=p=0", path)
                      
                      val process = ProcessBuilder(cmd)
                          .redirectErrorStream(true)
                          .start()
                      
                      val output = process.inputStream.bufferedReader().readText().trim()
                      process.waitFor()
                      
                      val parts = output.split(",")
                      if (parts.size >= 4) {
                          mapOf(
                              "codec" to parts[0],
                              "width" to (parts[1].toIntOrNull() ?: 0),
                              "height" to (parts[2].toIntOrNull() ?: 0),
                              "fps" to parts[3],
                              "duration" to (parts.getOrNull(4)?.toDoubleOrNull() ?: 0.0)
                          )
                      } else null
                  } catch (e: Exception) {
                      e.printStackTrace()
                      null
                  }
              }
          }
          KOTLIN_EOF
          
          echo "âœ… Kotlin FFmpeg Bridge å·²åˆ›å»º"

      # 8. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: flutter pub get

      # 9. ç”Ÿæˆç­¾å
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 10. æ„å»º Release APK
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 11. é‡å‘½åå¹¶ä¸Šä¼ 
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Release
          path: "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"
