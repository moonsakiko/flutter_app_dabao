# ===============================
# è§†é¢‘å·¥åŠ - GitHub Actions äº‘æ‰“åŒ…é…ç½®
# ä½¿ç”¨ JNI Libs ä¼ªè£…ç­–ç•¥ç»•è¿‡ Android 10+ æ‰§è¡Œé™åˆ¶
# ===============================

name: Flutter Build APK
on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  APP_NAME: "è§†é¢‘å·¥åŠ"
  FILE_NAME: "VideoCutter"

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      LANG: "en_US.UTF-8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # ä¸‹è½½ FFmpeg for Android (ä½¿ç”¨ JohnVanSickle é™æ€æ„å»ºï¼Œå·²éªŒè¯å¯ç”¨)
      - name: Download FFmpeg Binary
        run: |
          echo "ğŸ“¦ ä¸‹è½½ FFmpeg for Android arm64 (JohnVanSickle)..."
          mkdir -p assets/bin
          
          # ä¸‹è½½ tar.xz (çº¦ 38MB)
          echo "ğŸ“¥ Downloading from johnvansickle.com..."
          curl -L -f -o ffmpeg-release.tar.xz "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-arm64-static.tar.xz"
          
          # è§£å‹
          echo "ğŸ“‚ Extracting..."
          tar -xf ffmpeg-release.tar.xz
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          echo "ğŸ” Locating binaries..."
          find . -name "ffmpeg" -type f -executable | head -1 | xargs -I {} cp {} assets/bin/ffmpeg
          find . -name "ffprobe" -type f -executable | head -1 | xargs -I {} cp {} assets/bin/ffprobe
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          SIZE=$(stat -c%s "assets/bin/ffmpeg" 2>/dev/null || echo 0)
          echo "Checked FFmpeg size: $SIZE bytes"
          
          if [ "$SIZE" -gt 10000000 ]; then
             echo "âœ… FFmpeg ä¸‹è½½æˆåŠŸ"
          else
             echo "âŒ FFmpeg ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶è¿‡å°ï¼åœæ­¢æ„å»ºã€‚"
             exit 1
          fi

      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            flutter create . --platforms android --project-name video_cutter
          fi

      - name: Change App Name and Permissions
        run: |
          # ğŸ“¦ å…³é”®ç­–ç•¥ï¼šå°† FFmpeg ä¼ªè£…æˆ Shared Library (.so) æ”¾å…¥ jniLibs
          # è¿™æ · Android å®‰è£…æ—¶ä¼šè‡ªåŠ¨å°†å…¶è§£å‹åˆ°å…·æœ‰æ‰§è¡Œæƒé™çš„ nativeLibraryDir
          
          JNI_DIR="android/app/src/main/jniLibs/arm64-v8a"
          mkdir -p "$JNI_DIR"
          
          cp -f assets/bin/ffmpeg "$JNI_DIR/libffmpeg.so"
          cp -f assets/bin/ffprobe "$JNI_DIR/libffprobe.so"
          
          echo "âœ… FFmpeg moved to $JNI_DIR (Reinforced Execution Permission)"

          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          # ä¿®æ”¹ APP åç§°
          sed -i 's/android:label="[^"]*"/android:label="è§†é¢‘å·¥åŠ"/g' "$MANIFEST"
          
          # æ ¸å¿ƒæƒé™é…ç½®ï¼šextractNativeLibs=true (ç¡®ä¿è§£å‹so), requestLegacyExternalStorage=true (æ–‡ä»¶è®¿é—®)
          # æˆ‘ä»¬æ›¿æ¢ <application æ ‡ç­¾
          if ! grep -q "extractNativeLibs" "$MANIFEST"; then
             sed -i 's/<application/<application android:extractNativeLibs="true" android:requestLegacyExternalStorage="true"/g' "$MANIFEST"
          fi
          
          # æ·»åŠ å­˜å‚¨æƒé™
          if ! grep -q "READ_EXTERNAL_STORAGE" "$MANIFEST"; then
            sed -i 's/<application/<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO"\/>\n    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO"\/>\n\n    <application/g' "$MANIFEST"
          fi
          
          echo "âœ… AndroidManifest.xml å·²æ›´æ–°"

      - name: Fix Android Environment
        run: |
          # ä¿®å¤ Kotlin ç‰ˆæœ¬
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          # ä¿®å¤ minSdkVersion
          sed -i 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 21/g' android/app/build.gradle
          sed -i 's/minSdk = flutter.minSdkVersion/minSdk = 21/g' android/app/build.gradle
          
          echo "âœ… Android ç¯å¢ƒå·²ä¿®å¤"

      # åˆ›å»º Kotlin FFmpeg æ¡¥æ¥å±‚
      - name: Create Kotlin FFmpeg Bridge
        run: |
          # ç¡®ä¿ç›®å½•å­˜åœ¨ (Default Flutter package is com.example.video_cutter)
          KOTLIN_DIR="android/app/src/main/kotlin/com/example/video_cutter"
          mkdir -p "$KOTLIN_DIR"
          
          # Overwrite MainActivity.kt with Native Lib Solution
          cat > "$KOTLIN_DIR/MainActivity.kt" << 'EOF'
          package com.example.video_cutter

          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import java.io.FileOutputStream
          import android.util.Log
          import org.json.JSONObject

          class MainActivity: FlutterActivity() {
              private val CHANNEL = "com.videocutter/ffmpeg"
              private val TAG = "FFmpegBridge"
              private var statusInfo: String = "Initializing..."

              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result ->
                      when (call.method) {
                          "isReady" -> {
                              val ready = checkFFmpeg()
                              result.success(ready)
                          }
                          "cutVideo" -> {
                              Thread {
                                  if (!checkFFmpeg()) {
                                      runOnUiThread { result.success("FFmpeg Error: Binaries not found in $statusInfo") }
                                      return@Thread
                                  }
                                  try {
                                      val input = call.argument<String>("input")!!
                                      val output = call.argument<String>("output")!!
                                      val start = call.argument<String>("start")!!
                                      val end = call.argument<String>("end")!!
                                      val cmd = listOf(getFFmpegPath(), "-y", "-ss", start, "-to", end, "-i", input, "-c", "copy", "-avoid_negative_ts", "1", output)
                                      runFFmpeg(cmd, result)
                                  } catch (e: Exception) {
                                      runOnUiThread { result.success("Exception: ${e.message}") }
                                  }
                              }.start()
                          }
                          "stitchVideos" -> {
                              Thread {
                                  if (!checkFFmpeg()) {
                                      runOnUiThread { result.success("FFmpeg Error: Binaries not found in $statusInfo") }
                                      return@Thread
                                  }
                                  try {
                                      val inputs = call.argument<List<String>>("inputs")!!
                                      val output = call.argument<String>("output")!!
                                      val listFile = File(cacheDir, "list.txt")
                                      listFile.writeText(inputs.joinToString("\n") { "file '$it'" })
                                      val cmd = listOf(getFFmpegPath(), "-y", "-f", "concat", "-safe", "0", "-i", listFile.absolutePath, "-c", "copy", output)
                                      runFFmpeg(cmd, result)
                                  } catch (e: Exception) {
                                      runOnUiThread { result.success("Exception: ${e.message}") }
                                  }
                              }.start()
                          }
                          "analyzeVideo" -> {
                              Thread {
                                  if (!checkFFmpeg()) {
                                      runOnUiThread { result.success(null) }
                                      return@Thread
                                  }
                                  try {
                                      val path = call.argument<String>("path")!!
                                      val cmd = listOf(getFFprobePath(), "-v", "error", "-select_streams", "v:0", "-show_entries", "stream=width,height,r_frame_rate,codec_name,duration", "-of", "json", path)
                                      val process = ProcessBuilder(cmd).start()
                                      val output = process.inputStream.bufferedReader().readText()
                                      process.waitFor()
                                      
                                      if (output.isNotEmpty()) {
                                          try {
                                              val json = JSONObject(output)
                                              val streams = json.optJSONArray("streams")
                                              if (streams != null && streams.length() > 0) {
                                                  val stream = streams.getJSONObject(0)
                                                  val map = HashMap<String, Any>()
                                                  map["width"] = stream.optInt("width")
                                                  map["height"] = stream.optInt("height")
                                                  map["codec"] = stream.optString("codec_name")
                                                  map["fps"] = stream.optString("r_frame_rate")
                                                  map["duration"] = stream.optDouble("duration", 0.0)
                                                  runOnUiThread { result.success(map) }
                                                  return@Thread
                                              }
                                          } catch (e: Exception) {
                                              Log.e(TAG, "Parse Json failed", e)
                                          }
                                      }
                                      runOnUiThread { result.success(null) }
                                  } catch (e: Exception) {
                                      runOnUiThread { result.success(null) }
                                  }
                              }.start()
                          }
                          else -> result.notImplemented()
                      }
                  }
              }

              // Use Native Library Path (Executable on Android 10+)
              private fun getFFmpegPath() = File(applicationInfo.nativeLibraryDir, "libffmpeg.so").absolutePath
              private fun getFFprobePath() = File(applicationInfo.nativeLibraryDir, "libffprobe.so").absolutePath

              private fun checkFFmpeg(): Boolean {
                  val ffmpeg = File(getFFmpegPath())
                  if (ffmpeg.exists()) return true
                  
                  // Debug Info
                  try {
                      val dir = File(applicationInfo.nativeLibraryDir)
                      statusInfo = "${dir.absolutePath} content: " + (dir.list()?.joinToString(",") ?: "null")
                  } catch(e: Exception) {
                      statusInfo = "Check Error: $e"
                  }
                  return false
              }

              private fun runFFmpeg(cmd: List<String>, result: MethodChannel.Result) {
                  try {
                      val process = ProcessBuilder(cmd)
                          .redirectErrorStream(true)
                          .start()
                      
                      val output = process.inputStream.bufferedReader().readText()
                      val exitCode = process.waitFor()
                      
                      runOnUiThread {
                          if (exitCode == 0) {
                              result.success(true)
                          } else {
                              val log = "ExitCode: $exitCode\nCmd: $cmd\nFail Reason: Executable?\nOutput:\n$output\nDebug: $statusInfo"
                              Log.e(TAG, log)
                              result.success(log)
                          }
                      }
                  } catch (e: Exception) {
                      runOnUiThread { result.success("Process Exception: ${e.message}\nDebug: $statusInfo") }
                  }
              }
          }
          EOF
          
          echo "âœ… Kotlin FFmpeg Bridge (JNI Mode) å·²åˆ›å»º"

      - name: Install Dependencies
        run: flutter pub get

      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      - name: Check APK Size
        run: |
          SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-release.apk)
          echo "APK size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          if [ "$SIZE" -lt 5000000 ]; then
            echo "âš ï¸ APK è¾ƒå°ï¼ŒFFmpeg å¯èƒ½æœªæ­£ç¡®æ‰“åŒ…"
          else
            echo "âœ… APK å¤§å°æ­£å¸¸"
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Release
          path: build/app/outputs/flutter-apk/app-release.apk
