name: Flutter Build Signed Release
on:
  push:            # æäº¤ä»£ç å³è‡ªåŠ¨è§¦å‘
  workflow_dispatch: # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘

# ==============================
# ç”¨æˆ·è‡ªå®šä¹‰é…ç½®åŒº (è¯·åœ¨æ­¤å¤„ä¿®æ”¹å‚æ•°)
# ==============================
# è¿™æ˜¯ä¸‹è½½æ–‡ä»¶çš„åå­— (å¿…é¡»è‹±æ–‡)
# è¿™æ˜¯å®‰è£…åˆ°æ‰‹æœºä¸Šæ˜¾ç¤ºçš„ä¸­æ–‡å
env:
  FILE_NAME: "VideoCutter"
  APP_LABEL: "æ— æŸè§†é¢‘åˆ‡å‰²å™¨"
# ==============================

jobs:
  build:
    runs-on: ubuntu-latest
    
    # å¼ºåˆ¶è®¾ç½® UTF-8 ç¯å¢ƒ (è§£å†³ sed å†™å…¥ä¸­æ–‡ä¹±ç )
    env:
      LANG: "en_US.UTF-8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆå®‰å“å·¥ç¨‹éª¨æ¶
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            flutter create . --platforms android --project-name video_cutter
          fi

      # 2. ğŸ·ï¸ å¼ºåˆ¶ä¿®æ”¹ä¸­æ–‡å
      - name: Change App Name (UTF-8 Safe)
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          python3 -c "
          import re
          with open('$MANIFEST', 'r', encoding='utf-8') as f:
              content = f.read()
          new_content = re.sub(r'android:label=\"[^\"]*\"', 'android:label=\"${{ env.APP_LABEL }}\"', content)
          with open('$MANIFEST', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "
          echo "âœ… App label changed to: ${{ env.APP_LABEL }}"

      # 3. ğŸ’‰ ç¯å¢ƒè‡ªåŠ¨ä¿®å¤ (ä½¿ç”¨ Python å¼ºåˆ¶è¦†å†™é…ç½®æ–‡ä»¶)
      - name: Fix Android Environment
        run: |
          echo "ğŸ”§ [Step 1] Fixing Kotlin Version in settings.gradle..."
          python3 << 'EOF'
          import re
          
          # ä¿®å¤ settings.gradle ä¸­çš„ Kotlin ç‰ˆæœ¬
          with open('android/settings.gradle', 'r') as f:
              content = f.read()
          content = re.sub(
              r'id "org\.jetbrains\.kotlin\.android" version "[^"]*"',
              'id "org.jetbrains.kotlin.android" version "1.9.0"',
              content
          )
          with open('android/settings.gradle', 'w') as f:
              f.write(content)
          print("âœ… settings.gradle: Kotlin -> 1.9.0")
          EOF
          
          echo "ğŸ”§ [Step 2] Fixing build.gradle (app level) - Force SDK 34..."
          python3 << 'EOF'
          import re
          
          with open('android/app/build.gradle', 'r') as f:
              content = f.read()
          
          # æ›¿æ¢ flutter.compileSdkVersion ä¸º 34
          content = re.sub(r'compileSdk\s*=\s*flutter\.compileSdkVersion', 'compileSdk = 34', content)
          content = re.sub(r'compileSdkVersion\s+flutter\.compileSdkVersion', 'compileSdkVersion 34', content)
          
          # æ›¿æ¢ flutter.targetSdkVersion ä¸º 34
          content = re.sub(r'targetSdk\s*=\s*flutter\.targetSdkVersion', 'targetSdk = 34', content)
          content = re.sub(r'targetSdkVersion\s+flutter\.targetSdkVersion', 'targetSdkVersion 34', content)
          
          # æ›¿æ¢ flutter.minSdkVersion ä¸º 24
          content = re.sub(r'minSdk\s*=\s*flutter\.minSdkVersion', 'minSdk = 24', content)
          content = re.sub(r'minSdkVersion\s+flutter\.minSdkVersion', 'minSdkVersion 24', content)
          
          # æ›¿æ¢ä»»ä½•ç¡¬ç¼–ç çš„å€¼
          content = re.sub(r'minSdkVersion\s+\d+', 'minSdkVersion 24', content)
          content = re.sub(r'minSdk\s*=\s*\d+', 'minSdk = 24', content)
          
          with open('android/app/build.gradle', 'w') as f:
              f.write(content)
          print("âœ… build.gradle: compileSdk=34, targetSdk=34, minSdk=24")
          EOF
          
          echo "ğŸ”§ [Step 3] Adding Kotlin version to project build.gradle..."
          python3 << 'EOF'
          with open('android/build.gradle', 'r') as f:
              content = f.read()
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰ ext.kotlin_version
          if 'ext.kotlin_version' not in content:
              # åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ 
              content = "buildscript { ext.kotlin_version = '1.9.0' }\n" + content
          
          with open('android/build.gradle', 'w') as f:
              f.write(content)
          print("âœ… project build.gradle: ext.kotlin_version = 1.9.0")
          EOF
          
          echo "ğŸ”§ [Step 4] Adding permissions to AndroidManifest.xml..."
          python3 << 'EOF'
          with open('android/app/src/main/AndroidManifest.xml', 'r', encoding='utf-8') as f:
              content = f.read()
          
          permissions = '''
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.READ_MEDIA_VIDEO"/>
          '''
          
          if 'READ_MEDIA_VIDEO' not in content:
              content = content.replace('</manifest>', permissions + '\n</manifest>')
              with open('android/app/src/main/AndroidManifest.xml', 'w', encoding='utf-8') as f:
                  f.write(content)
          print("âœ… AndroidManifest.xml: permissions added")
          EOF
          
          echo "âœ… All Android environment fixes applied!"

      # 4. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: flutter pub get

      # 5. ç”Ÿæˆå›¾æ ‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      - name: Generate App Icon
        run: |
          if [ -f "assets/images/icon.png" ]; then
            echo "ğŸ¨ Generating App Icon..."
            dart run flutter_launcher_icons
          else
            echo "âš ï¸ No icon.png found, skipping icon generation"
          fi

      # 6. ğŸ”‘ äº‘ç«¯ç”Ÿæˆç­¾å
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 7. âœ¨ æè‡´å‹ç¼©æ‰“åŒ…
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 8. é‡å‘½åä¸ºè‹±æ–‡æ–‡ä»¶å
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"

      # 9. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Install_Package
          path: "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"
