name: Flutter Build Signed Release
on:
  push:            # æäº¤ä»£ç å³è‡ªåŠ¨è§¦å‘
  workflow_dispatch: # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘

# ==============================
# ç”¨æˆ·è‡ªå®šä¹‰é…ç½®åŒº (è¯·åœ¨æ­¤å¤„ä¿®æ”¹å‚æ•°)
# ==============================
# è¿™æ˜¯ä¸‹è½½æ–‡ä»¶çš„åå­— (å¿…é¡»è‹±æ–‡)
# è¿™æ˜¯å®‰è£…åˆ°æ‰‹æœºä¸Šæ˜¾ç¤ºçš„ä¸­æ–‡å
env:
  FILE_NAME: "VideoCutter"
  APP_LABEL: "æ— æŸè§†é¢‘åˆ‡å‰²å™¨"
# ==============================

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      LANG: "en_US.UTF-8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # ğŸ”¥ å…³é”®ä¿®å¤ï¼šåˆ é™¤æœ‰é—®é¢˜çš„ Android SDK 35ï¼Œå¼ºåˆ¶ä½¿ç”¨ SDK 34
      - name: Fix Android SDK (Remove Broken SDK 35)
        run: |
          echo "ğŸ”§ Removing broken Android SDK 35..."
          rm -rf $ANDROID_SDK_ROOT/platforms/android-35 || true
          rm -rf $ANDROID_HOME/platforms/android-35 || true
          
          echo "ğŸ“¦ Installing Android SDK 34..."
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0"
          
          echo "âœ… Android SDK fixed!"
          ls -la $ANDROID_SDK_ROOT/platforms/

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆå®‰å“å·¥ç¨‹éª¨æ¶
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            flutter create . --platforms android --project-name video_cutter
          fi

      # 2. ğŸ·ï¸ å¼ºåˆ¶ä¿®æ”¹ä¸­æ–‡å
      - name: Change App Name (UTF-8 Safe)
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          python3 -c "
          import re
          with open('$MANIFEST', 'r', encoding='utf-8') as f:
              content = f.read()
          new_content = re.sub(r'android:label=\"[^\"]*\"', 'android:label=\"${{ env.APP_LABEL }}\"', content)
          with open('$MANIFEST', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "
          echo "âœ… App label changed to: ${{ env.APP_LABEL }}"

      # 3. ğŸ’‰ ç¯å¢ƒè‡ªåŠ¨ä¿®å¤ (Kotlin + SDK ç‰ˆæœ¬)
      - name: Fix Android Environment
        run: |
          echo "ğŸ”§ [Step 1] Fixing Kotlin Version in settings.gradle..."
          python3 << 'EOF'
          import re
          
          with open('android/settings.gradle', 'r') as f:
              content = f.read()
          content = re.sub(
              r'id "org\.jetbrains\.kotlin\.android" version "[^"]*"',
              'id "org.jetbrains.kotlin.android" version "1.9.0"',
              content
          )
          with open('android/settings.gradle', 'w') as f:
              f.write(content)
          print("âœ… settings.gradle: Kotlin -> 1.9.0")
          EOF
          
          echo "ğŸ”§ [Step 2] Fixing build.gradle (app level) - Force SDK 34..."
          python3 << 'EOF'
          import re
          
          with open('android/app/build.gradle', 'r') as f:
              content = f.read()
          
          # æ›¿æ¢æ‰€æœ‰ flutter.xxx å˜é‡ä¸ºç¡¬ç¼–ç å€¼
          content = re.sub(r'flutter\.compileSdkVersion', '34', content)
          content = re.sub(r'flutter\.targetSdkVersion', '34', content)
          content = re.sub(r'flutter\.minSdkVersion', '24', content)
          
          with open('android/app/build.gradle', 'w') as f:
              f.write(content)
          print("âœ… build.gradle: SDK versions fixed")
          EOF
          
          echo "ğŸ”§ [Step 3] Adding permissions to AndroidManifest.xml..."
          python3 << 'EOF'
          with open('android/app/src/main/AndroidManifest.xml', 'r', encoding='utf-8') as f:
              content = f.read()
          
          permissions = '''
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
              <uses-permission android:name="android.permission.READ_MEDIA_VIDEO"/>
          '''
          
          if 'READ_MEDIA_VIDEO' not in content:
              content = content.replace('</manifest>', permissions + '\n</manifest>')
              with open('android/app/src/main/AndroidManifest.xml', 'w', encoding='utf-8') as f:
                  f.write(content)
          print("âœ… AndroidManifest.xml: permissions added")
          EOF
          
          echo "âœ… All fixes applied!"

      # 4. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: flutter pub get

      # 5. ç”Ÿæˆå›¾æ ‡
      - name: Generate App Icon
        run: |
          if [ -f "assets/images/icon.png" ]; then
            echo "ğŸ¨ Generating App Icon..."
            dart run flutter_launcher_icons
          else
            echo "âš ï¸ No icon.png found, skipping"
          fi

      # 6. ğŸ”‘ äº‘ç«¯ç”Ÿæˆç­¾å
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 7. âœ¨ æ„å»º APK
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 8. é‡å‘½å
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"

      # 9. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Install_Package
          path: "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"
