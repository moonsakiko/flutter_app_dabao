name: Build Android Release
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

# å…¨å±€é…ç½®ä¸­å¿ƒ
env:
  APP_NAME: "å°çº¢ä¹¦ä¸‹è½½å™¨"      # å®‰è£…åˆ°æ‰‹æœºæ˜¾ç¤ºçš„ä¸­æ–‡å
  FILE_NAME: "XHS_Downloader" # ä¸‹è½½çš„æ–‡ä»¶å (è‹±æ–‡)
  APP_Package_Name: "xhs_downloader_app" # é¡¹ç›®æ–‡ä»¶å¤¹å (å¿…é¡»ä¸ pubspec.yaml ä¸€è‡´)

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      LANG: "en_US.UTF-8" # è§£å†³ä¸­æ–‡ä¹±ç 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆ Android å·¥ç¨‹éª¨æ¶ (å› ä¸ºæˆ‘ä»¬ä¸ä¸Šä¼  android ç›®å½•)
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            echo "ğŸš€ Generating Android Scaffold..."
            flutter create . --platforms android --project-name ${{ env.APP_Package_Name }}
          fi

      # 2. æ³¨å…¥ä¸­æ–‡åç§° (Manifest)
      - name: Set App Name (Chinese)
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          python3 -c "
          import re
          with open('$MANIFEST', 'r', encoding='utf-8') as f:
              content = f.read()
          # æ›¿æ¢ label
          new_content = re.sub(r'android:label=\"[^\"]*\"', 'android:label=\"${{ env.APP_NAME }}\"', content)
          with open('$MANIFEST', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "
          echo "âœ… App Name set to: ${{ env.APP_NAME }}"

      # 3. ä¿®å¤ç¯å¢ƒ (Kotlin 1.9.0 & MinSDK 21)
      - name: Fix Android Environment
        run: |
          echo "ğŸ”§ Fixing Kotlin Version to 1.9.0..."
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          echo "ğŸ”§ Fixing MinSdkVersion to 21..."
          sed -i 's/minSdkVersion.*/minSdkVersion 21/g' android/app/build.gradle

      - name: Install Dependencies
        run: flutter pub get

      # 4. ç”Ÿæˆå›¾æ ‡å’Œå¯åŠ¨é¡µ (SKIPPED: No Assets)
      # - name: Generate Assets

      # 5. äº‘ç«¯ç­¾å (Keystore)
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=User, O=User, L=City, S=State, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 6. æ‰“åŒ… Release APK
      - name: Build Release APK
        run: flutter build apk --release --target-platform android-arm64

      # 7. é‡å‘½åä¸ä¸Šä¼ 
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Install_Package
          path: build/app/outputs/flutter-apk/app-release.apk
