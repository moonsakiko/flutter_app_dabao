name: Flutter Build Final Release
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. é…ç½®åŸºç¡€ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 2. ç”Ÿæˆå®‰å“å·¥ç¨‹éª¨æ¶
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            # å¼ºåˆ¶æŒ‡å®šé¡¹ç›®åï¼Œé˜²æ­¢æ–‡ä»¶å¤¹å¤§å°å†™å¯¼è‡´æŠ¥é”™
            flutter create . --platforms android --project-name my_diary_app
          fi

      # 3. ğŸ’‰ã€å…³é”®æ­¥éª¤ã€‘ç¯å¢ƒè‡ªåŠ¨ä¿®å¤
      # è§£å†³ share_plus ç­‰æ–°æ’ä»¶å¯¼è‡´çš„ Kotlin ç‰ˆæœ¬å†²çªå’Œ MinSDK æŠ¥é”™
      - name: Fix Android Environment
        run: |
          echo "ğŸ”§ Fixing Kotlin Version to 1.9.0..."
          # ä¿®æ”¹ settings.gradle ä¸­çš„æ’ä»¶ç‰ˆæœ¬
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          # ä¿é™©èµ·è§ï¼Œå°è¯•ä¿®æ”¹ build.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          echo "ğŸ”§ Fixing MinSdkVersion to 21..."
          # ä¿®æ”¹ app/build.gradle ä¸­çš„æœ€ä½æ”¯æŒç‰ˆæœ¬
          sed -i 's/minSdkVersion.*/minSdkVersion 21/g' android/app/build.gradle

      - name: Install Dependencies
        run: flutter pub get

      # 4. ğŸ”‘ã€å…³é”®æ­¥éª¤ã€‘äº‘ç«¯ç”Ÿæˆç­¾å
      # Release åŒ…å¿…é¡»ç­¾åã€‚è¿™é‡Œæˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šç°åœºé€ ä¸€ä¸ªè¯ä¹¦ã€‚
      - name: Generate Keystore
        run: |
          # 1. ç”Ÿæˆ upload-keystore.jks æ–‡ä»¶
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          # 2. ç”Ÿæˆ key.properties é…ç½®æ–‡ä»¶
          # Flutter ç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨è¯»å–è¿™ä¸ªæ–‡ä»¶æ¥å¯»æ‰¾å¯†é’¥
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 5. âœ¨ã€æé™ç˜¦èº«ã€‘æ‰“åŒ… Release + ARM64
      # --release: å¼€å¯æ··æ·†å’Œå‹ç¼©
      # --target-platform: åªä¿ç•™ç›®å‰99%æ‰‹æœºé€šç”¨çš„ arm64 æ¶æ„
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 6. ä¸Šä¼ æœ€ç»ˆäº§ç‰©
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: diary-app-release-final
          path: build/app/outputs/flutter-apk/app-release.apk