name: Flutter Build Stable
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆå®‰å“å·¥ç¨‹
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            echo "âš ï¸ Generating Android scaffold..."
            flutter create . --platforms android --project-name my_diary_app
          fi

      # 2. ğŸ’‰ã€æš´åŠ›ä¿®å¤ã€‘MinSDK é—®é¢˜
      # è¿™æ¬¡ä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸ç®¡ä¸­é—´æœ‰å‡ ä¸ªç©ºæ ¼ï¼Œç»Ÿç»Ÿæ›¿æ¢æˆ 21
      - name: Force MinSDK to 21
        run: |
          # æŸ¥æ‰¾ android/app/build.gradle
          # åªè¦çœ‹åˆ° minSdkVersion åé¢è·Ÿç€ä»»ä½•ä¸œè¥¿ï¼Œæ•´è¡Œæ›¿æ¢ä¸º minSdkVersion 21
          sed -i 's/minSdkVersion.*/minSdkVersion 21/g' android/app/build.gradle
          
          # æ‰“å°å‡ºæ¥æ£€æŸ¥ä¸€ä¸‹ï¼Œç¡®ä¿æ”¹æˆåŠŸäº†
          grep "minSdkVersion" android/app/build.gradle

      - name: Install Dependencies
        run: flutter pub get

      # 3. ğŸ›¡ï¸ æ‰“åŒ… Debug ç‰ˆ + åªä¿ç•™ ARM64
      # æ”¾å¼ƒ release æ¨¡å¼ï¼Œå› ä¸ºäº‘ç«¯ç­¾åå¤ªå®¹æ˜“å‡ºé”™äº†
      # ä½¿ç”¨ debug ç­¾åç¡®ä¿ä½ èƒ½å®‰è£…ï¼ŒåŒæ—¶ arm64 å‚æ•°èƒ½å¤§å¹…å‡å°ä½“ç§¯
      - name: Build APK
        run: flutter build apk --debug --target-platform android-arm64

      # 4. ä¸Šä¼ 
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: diary-app-v1.3-optimized
          path: build/app/outputs/flutter-apk/app-debug.apk
