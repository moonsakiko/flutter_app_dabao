name: Flutter Build Final Release
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆå®‰å“å·¥ç¨‹
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            flutter create . --platforms android --project-name my_diary_app
          fi

      # 2. ğŸ’‰ã€ç¯å¢ƒä¿®å¤ã€‘(æ²¿ç”¨ä¸Šä¸€æ¬¡æˆåŠŸçš„æ–¹æ¡ˆ)
      # å‡çº§ Kotlin åˆ° 1.9.0ï¼Œä¿®å¤ MinSDK åˆ° 21
      - name: Fix Android Environment
        run: |
          # ä¿®å¤ Kotlin ç‰ˆæœ¬
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          # ä¿®å¤ MinSDK
          sed -i 's/minSdkVersion.*/minSdkVersion 21/g' android/app/build.gradle

      - name: Install Dependencies
        run: flutter pub get

      - name: Generate Icons & Splash
        run: |
          echo "ğŸ¨ Generating App Icons..."
          dart run flutter_launcher_icons
          
          echo "ğŸ–¼ï¸ Generating Splash Screen..."
          dart run flutter_native_splash:create

      # 3. ğŸ”‘ã€å¯†é’¥ç”Ÿæˆã€‘(Release æ¨¡å¼å¿…é¡»)
      # ç°åœºé€ ä¸€ä¸ªç­¾åè¯ä¹¦ï¼Œéª—è¿‡ç¼–è¯‘å™¨
      - name: Generate Keystore
        run: |
          # ç”Ÿæˆè¯ä¹¦æ–‡ä»¶
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          # ç”Ÿæˆé…ç½®æ–‡ä»¶ (Flutter é»˜è®¤è¯»å–è¿™ä¸ªæ–‡ä»¶)
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 4. âœ¨ã€æè‡´æ‰“åŒ…ã€‘Release + ARM64
      # è¿™æ¬¡ç”Ÿæˆçš„åŒ…ï¼Œä½“ç§¯ä¼šæå…¶æ„Ÿäºº
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 5. ä¸Šä¼  (æ–‡ä»¶åæ”¹æˆäº† release)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: diary-app-release-final
          path: build/app/outputs/flutter-apk/app-release.apk
