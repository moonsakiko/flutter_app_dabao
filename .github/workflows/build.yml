name: Flutter Build Final Fix
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆå®‰å“å·¥ç¨‹
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            echo "âš ï¸ Generating Android scaffold..."
            flutter create . --platforms android --project-name my_diary_app
          fi

      # 2. ğŸ’‰ã€æ ¸æ­¦å™¨ä¿®å¤ã€‘å¼ºåˆ¶æ³¨å…¥é…ç½®
      # ä¸å»æŸ¥æ‰¾æ›¿æ¢äº†ï¼Œç›´æ¥åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ é…ç½®ï¼Œç»å¯¹ä¸ä¼šæŠ¥é”™
      - name: Fix Android Dependencies
        run: |
          echo "ğŸ”§ Fixing MinSDK..."
          # 1. ä¿®å¤ MinSDK (è¿™ä¸ªä¹‹å‰éªŒè¯è¿‡æ˜¯å¥½ä½¿çš„)
          sed -i 's/minSdkVersion.*/minSdkVersion 21/g' android/app/build.gradle
          
          echo "ğŸ”§ Injecting Resolution Strategy..."
          # 2. ä¿®å¤ Kotlin å†²çª (ç›´æ¥è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾)
          # è¿™æ®µä»£ç ä¼šå¼ºåˆ¶æ‰€æœ‰ Kotlin åº“ä½¿ç”¨ 1.9.0 ç‰ˆæœ¬
          cat <<EOF >> android/app/build.gradle
          
          // --- AI è‡ªåŠ¨æ³¨å…¥çš„ä¿®å¤ä»£ç  ---
          configurations.all {
              resolutionStrategy {
                  force "org.jetbrains.kotlin:kotlin-stdlib:1.9.0"
                  force "org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.9.0"
                  force "org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.9.0"
              }
          }
          EOF
          
          echo "âœ… Injection complete."

      - name: Install Dependencies
        run: flutter pub get

      # 3. ğŸ›¡ï¸ æ‰“åŒ… Debug ç‰ˆ + åªä¿ç•™ ARM64
      - name: Build APK
        run: flutter build apk --debug --target-platform android-arm64

      # 4. ä¸Šä¼ 
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: diary-app-final
          path: build/app/outputs/flutter-apk/app-debug.apk
