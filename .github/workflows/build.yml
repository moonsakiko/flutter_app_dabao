name: Build Lofter Fixer App
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šæ™ºèƒ½èåˆå·¥ç¨‹ ğŸ‘‡ğŸ‘‡ğŸ‘‡
      - name: Rebuild Android Project with User Code
        run: |
          # 1. å¦‚æœç”¨æˆ·ä¸Šä¼ äº†éƒ¨åˆ† android ä»£ç ï¼Œå…ˆå¤‡ä»½èµ·æ¥
          if [ -d "android" ]; then
            echo "ğŸ“‚ Detected existing android code, backing up..."
            mv android android_user_backup
          fi

          # 2. å¼ºè¡Œç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„ã€å®Œæ•´çš„å®‰å“å·¥ç¨‹éª¨æ¶
          echo "ğŸ”¨ Generating fresh Android scaffold..."
          flutter create . --platforms android --project-name lofter_fixer

          # 3. å¦‚æœæœ‰å¤‡ä»½ï¼ŒæŠŠç”¨æˆ·çš„æ ¸å¿ƒä»£ç è¦†ç›–å›å»
          if [ -d "android_user_backup" ]; then
            echo "â™»ï¸ Restoring user's custom code (MainActivity, build.gradle, etc)..."
            # ä½¿ç”¨ cp -r å¼ºåˆ¶è¦†ç›– (-f)
            cp -rf android_user_backup/* android/
            # æ¸…ç†å¤‡ä»½
            rm -rf android_user_backup
          fi
          
          # 4. æ£€æŸ¥æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ ! -f "android/settings.gradle" ]; then
             echo "âŒ Error: settings.gradle still missing!"
             exit 1
          fi

      # ğŸ”§ æ”¾ç½®æ¨¡å‹æ–‡ä»¶ (å¦‚æœæ²¡æœ‰ä¸Šä¼ ï¼Œåˆ›å»ºä¸€ä¸ªå‡çš„é˜²æ­¢ç¼–è¯‘æŠ¥é”™)
      - name: Place TFLite Model
        run: |
          mkdir -p android/app/src/main/assets
          if [ -f "best_float16.tflite" ]; then
            cp best_float16.tflite android/app/src/main/assets/
            echo "âœ… Model copied."
          else
            echo "âš ï¸ Model NOT found in root! Creating dummy file to pass build..."
            touch android/app/src/main/assets/best_float16.tflite 
          fi

      # ğŸ’‰ æ³¨å…¥ä¾èµ– (é’ˆå¯¹ Flutter 3.19+ å’Œ OpenCV çš„å…¼å®¹æ€§ä¿®å¤)
      - name: Inject Dependencies & Fix Environment
        run: |
          echo "ğŸ”§ Injecting Kotlin 1.9.0..."
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          
          echo "ğŸ”§ Injecting MinSDK 24..."
          sed -i 's/minSdkVersion.*/minSdkVersion 24/g' android/app/build.gradle
          
          # å¦‚æœç”¨æˆ·æ²¡æœ‰ä¸Šä¼  build.gradleï¼Œæˆ‘ä»¬éœ€è¦è‡ªåŠ¨æ³¨å…¥ OpenCV å’Œ Tensorflow
          # æ£€æŸ¥ build.gradle æ˜¯å¦åŒ…å« opencvï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ‰‹åŠ¨è¿½åŠ 
          if ! grep -q "com.quickbirdstudios:opencv" android/app/build.gradle; then
             echo "ğŸ”§ Injecting Native Dependencies (OpenCV & TFLite)..."
             # æ‰¾åˆ° dependencies { ... } å—å¹¶åœ¨å…¶ä¸­æ’å…¥
             # è¿™é‡Œä½¿ç”¨æ¯”è¾ƒç®€å•çš„è¿½åŠ æ–¹å¼ï¼ˆåœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ å¯èƒ½ä¼šå¤±æ•ˆï¼Œè¦åœ¨ dependencies é—­åŒ…å†…ï¼‰
             # æˆ‘ä»¬é‡‡ç”¨æœ€ç¨³å¦¥çš„æ–¹å¼ï¼šç›´æ¥æ›¿æ¢æ•´ä¸ª dependencies å— (å¦‚æœç”¨æˆ·æ²¡ä¼  gradle)
             
             # ä½†ç”±äºæˆ‘ä»¬ä¸Šé¢åšäº†â€œå¤‡ä»½è¦†ç›–â€ï¼Œå¦‚æœä½ ä¸Šä¼ äº† build.gradleï¼Œè¿™é‡Œä¸éœ€è¦åŠ¨ã€‚
             # å¦‚æœä½ æ²¡ä¸Šä¼  build.gradleï¼Œä¸‹é¢çš„ sed ä¼šå°è¯•æ³¨å…¥ã€‚
             sed -i '/dependencies {/a \    implementation "org.tensorflow:tensorflow-lite:2.14.0"\n    implementation "org.tensorflow:tensorflow-lite-support:0.4.4"\n    implementation "com.quickbirdstudios:opencv:4.5.3.0"\n    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.1"' android/app/build.gradle
          else
             echo "âœ… Custom dependencies detected in build.gradle, skipping injection."
          fi

      - name: Install Dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: LofterFixer-Release
          path: build/app/outputs/flutter-apk/app-release.apk