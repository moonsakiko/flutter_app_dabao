name: Flutter Build Kotlin Fix
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆå®‰å“å·¥ç¨‹
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            echo "âš ï¸ Generating Android scaffold..."
            flutter create . --platforms android --project-name my_diary_app
          fi

      # 2. ğŸ’‰ã€ç²¾å‡†æ‰‹æœ¯ã€‘å‡çº§ Kotlin ç¼–è¯‘å™¨ + ä¿®å¤ MinSDK
      # è¿™æ¬¡æˆ‘ä»¬ç›´æ¥ä¿®æ”¹ settings.gradleï¼Œè¿™æ˜¯ Flutter 3.19 æ§åˆ¶ç‰ˆæœ¬çš„åœ°æ–¹
      - name: Upgrade Kotlin & MinSDK
        run: |
          echo "ğŸ”§ Upgrading Kotlin Plugin to 1.9.0..."
          # åœ¨ android/settings.gradle é‡Œæ‰¾åˆ°æ—§ç‰ˆæœ¬å·å¹¶æ›¿æ¢
          # é»˜è®¤é€šå¸¸æ˜¯ 1.7.10ï¼Œæˆ‘ä»¬æŠŠå®ƒæ¢æˆ 1.9.0
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          
          # ä¸ºäº†ä¿é™©ï¼Œä¹Ÿå°è¯•ä¿®æ”¹ build.gradle (é˜²æ­¢æ—§æ¨¡æ¿ç»“æ„)
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle

          echo "ğŸ”§ Fixing MinSdkVersion to 21..."
          sed -i 's/minSdkVersion.*/minSdkVersion 21/g' android/app/build.gradle

          echo "âœ… Check versions:"
          grep "org.jetbrains.kotlin.android" android/settings.gradle || echo "Not found in settings.gradle"
          grep "minSdkVersion" android/app/build.gradle

      - name: Install Dependencies
        run: flutter pub get

      # 3. ğŸ›¡ï¸ æ‰“åŒ… Debug ç‰ˆ + ARM64
      - name: Build APK
        run: flutter build apk --debug --target-platform android-arm64

      # 4. ä¸Šä¼ 
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: diary-app-kotlin-fixed
          path: build/app/outputs/flutter-apk/app-debug.apk
