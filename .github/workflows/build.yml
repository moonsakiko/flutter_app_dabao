# ===============================
# è§†é¢‘å·¥åŠ - GitHub Actions äº‘æ‰“åŒ…é…ç½®
# æ–¹æ¡ˆï¼šä½¿ç”¨ FFmpegKit (Native Library Framework)
# ===============================

name: Flutter Build APK
on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  APP_NAME: "è§†é¢‘å·¥åŠ"
  FILE_NAME: "VideoCutter"

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      LANG: "en_US.UTF-8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      - name: Create Android Project
        run: |
          if [ ! -f "android/settings.gradle" ]; then
            echo "âš ï¸ Android project incomplete. Re-creating..."
            flutter create . --platforms android --project-name video_cutter
          fi

      - name: Configure Manifest (Name & Permissions)
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          # ä¿®æ”¹ APP åç§°
          sed -i 's/android:label="[^"]*"/android:label="è§†é¢‘å·¥åŠ"/g' "$MANIFEST"
          
          # æ·»åŠ å¿…è¦çš„å­˜å‚¨å’Œæ–‡ä»¶è®¿é—®æƒé™
          if ! grep -q "READ_EXTERNAL_STORAGE" "$MANIFEST"; then
            sed -i 's/<application/<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO"\/>\n    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO"\/>\n\n    <application/g' "$MANIFEST"
          fi
          
          if ! grep -q "requestLegacyExternalStorage" "$MANIFEST"; then
             sed -i 's/<application/<application android:requestLegacyExternalStorage="true"/g' "$MANIFEST"
          fi
          
          echo "âœ… AndroidManifest.xml å·²æ›´æ–°"

      - name: Configure Gradle Environment
        run: |
          # 1. ä¿®å¤ Kotlin ç‰ˆæœ¬
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          # 2. å‡çº§ MinSDK åˆ° 24 å¹¶é”å®š CompileSDK åˆ° 34 (é¿å‘ Android 15)
          # æ³¨æ„ï¼šFlutter æ–°æ—§æ¨¡æ¿å¯èƒ½ä½¿ç”¨ compileSdkVersion æˆ– compileSdkï¼Œéœ€åŒæ—¶è¦†ç›–
          sed -i 's/compileSdkVersion .*/compileSdkVersion 34/g' android/app/build.gradle
          sed -i 's/compileSdk .*/compileSdk = 34/g' android/app/build.gradle
          sed -i 's/targetSdkVersion .*/targetSdkVersion 34/g' android/app/build.gradle
          sed -i 's/targetSdk .*/targetSdk = 34/g' android/app/build.gradle
          
          # ç¡®ä¿ MinSDK ä¸º 24
          sed -i 's/minSdkVersion .*/minSdkVersion 24/g' android/app/build.gradle
          sed -i 's/minSdk .*/minSdk = 24/g' android/app/build.gradle
          
          # 3. ğŸŸ¢ å¼ºåŠ›ä»“åº“ä¿®å¤ (Ultimate Repository Fix)
          # è®¸å¤šæ–°ç‰ˆ Flutter é¡¹ç›®é»˜è®¤é”å®šä»“åº“é…ç½® (FAIL_ON_PROJECT_REPOS)
          # å¿…é¡»å…ˆè§£é”ï¼Œç„¶ååœ¨ Project çº§åˆ«å¼ºåˆ¶æ³¨å…¥ MavenCentral
          
          echo "ğŸ”“ Unlocking Gradle Repositories..."
          find android -name "settings.gradle" -exec sed -i 's/FAIL_ON_PROJECT_REPOS/PREFER_PROJECT/g' {} +
          
          echo "ğŸ’‰ Injecting All Repositories..."
          # ç›´æ¥è¿½åŠ åˆ° build.gradle æœ«å°¾ï¼Œç¡®ä¿å³ä½¿ plugins å—å­˜åœ¨ä¹Ÿèƒ½ç”Ÿæ•ˆ
          printf "\nallprojects {\n    repositories {\n        google()\n        mavenCentral()\n        maven { url 'https://jitpack.io' }\n    }\n}\n" >> android/build.gradle
          
          # 4. ğŸŸ¢ ä½¿ç”¨æ ‡å‡†å±æ€§è¦†ç›– (Standard Property Override)
          # è®¸å¤š Flutter æ’ä»¶ä¼šè¯»å– project properties æ¥è®¾ç½® SDK ç‰ˆæœ¬
          echo "flutter.compileSdkVersion=34" >> android/gradle.properties
          echo "flutter.targetSdkVersion=34" >> android/gradle.properties
          echo "flutter.minSdkVersion=24" >> android/gradle.properties
          echo "compileSdkVersion=34" >> android/gradle.properties
          echo "targetSdkVersion=34" >> android/gradle.properties
          
          echo "âœ… Maven & Properties é…ç½®å®Œæˆ"

      - name: Install Dependencies
        run: flutter pub get

      - name: ğŸ©¹ Patch Broken Plugins (Surgery)
        run: |
          echo "Finding ffmpeg_kit_flutter_new in pub-cache..."
          # æŸ¥æ‰¾ pub cache ä¸­çš„æ’ä»¶è·¯å¾„
          PLUGIN_PATH=$(find $HOME/.pub-cache -name "ffmpeg_kit_flutter_new*" -type d | head -n 1)
          
          if [ -z "$PLUGIN_PATH" ]; then
             echo "âŒ Plugin not found in default cache, trying local .dart_tool..."
             # æœ‰æ—¶ CI ç¯å¢ƒä¼šæŠŠ cache æ”¾åˆ«å¤„ï¼Œå°è¯•å¦ä¸€è·¯å¾„
             PLUGIN_PATH=$(find .dart_tool/pub/files -name "ffmpeg_kit_flutter_new*" -type d 2>/dev/null | head -n 1)
          fi
          
          if [ -n "$PLUGIN_PATH" ]; then
             echo "âœ… Found plugin at: $PLUGIN_PATH"
             GRADLE_FILE="$PLUGIN_PATH/android/build.gradle"
             
             if [ -f "$GRADLE_FILE" ]; then
                echo "ğŸ”§ Patching $GRADLE_FILE..."
                # å¼ºåˆ¶æ›¿æ¢ compileSdkVersion å’Œ targetSdkVersion
                # ä½¿ç”¨ sed å¼ºè¡ŒæŠŠä»»ä½• compileSdk (åŒ…æ‹¬ 35 æˆ–å˜é‡) æ›¿æ¢ä¸º 34
                sed -i 's/compileSdkVersion .*/compileSdkVersion 34/g' "$GRADLE_FILE"
                sed -i 's/compileSdk .*/compileSdk = 34/g' "$GRADLE_FILE"
                sed -i 's/targetSdkVersion .*/targetSdkVersion 34/g' "$GRADLE_FILE"
                sed -i 's/targetSdk .*/targetSdk = 34/g' "$GRADLE_FILE"
                
                cat "$GRADLE_FILE" | grep "compileSdk"
                echo "âœ… Patch applied successfully."
             else
                echo "âš ï¸ Plugin found but build.gradle missing!"
             fi
          else
             echo "âš ï¸ Could not locate ffmpeg_kit_flutter_new package to patch."
          fi

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.2

      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      - name: Build APK (Detailed)
        # ä½¿ç”¨è¯¦ç»†æ—¥å¿—ä»¥ä¾¿æ’æŸ¥
        run: flutter build apk --release --verbose

      - name: Check APK Size
        run: |
          SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-release.apk)
          echo "APK size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          if [ "$SIZE" -lt 20000000 ]; then
            echo "âš ï¸ APK è¿‡å°ï¼Œä¾èµ–å¯èƒ½æœªæ­£ç¡®æ‰“åŒ…"
            exit 1
          else
            echo "âœ… APK å¤§å°æ­£å¸¸ (åŒ…å«åŸç”Ÿåº“)"
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Release
          path: build/app/outputs/flutter-apk/app-release.apk
