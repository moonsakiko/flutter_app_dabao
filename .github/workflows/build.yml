# ===============================
# è§†é¢‘å·¥åŠ - GitHub Actions äº‘æ‰“åŒ…é…ç½®
# ===============================
# ç‚¹å‡» Actions -> Run workflow å³å¯æ‰“åŒ…
# ===============================

name: Flutter Build APK
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

# ğŸ‘‡ åœ¨è¿™é‡Œä¿®æ”¹ APP ä¸­æ–‡å
env:
  APP_NAME: "è§†é¢‘å·¥åŠ"
  FILE_NAME: "VideoCutter"

jobs:
  build:
    runs-on: ubuntu-latest
    
    # è®¾ç½® UTF-8 ç¯å¢ƒï¼Œé˜²æ­¢ä¸­æ–‡ä¹±ç 
    env:
      LANG: "en_US.UTF-8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. é…ç½® Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 2. é…ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 3. ç”Ÿæˆ Android å·¥ç¨‹éª¨æ¶
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            echo "ğŸ“¦ ç”Ÿæˆ Android å·¥ç¨‹..."
            flutter create . --platforms android --project-name video_cutter
          fi

      # 4. ä¿®æ”¹ APP ä¸­æ–‡å
      - name: Change App Name
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          python3 -c "
          import re
          with open('$MANIFEST', 'r', encoding='utf-8') as f:
              content = f.read()
          new_content = re.sub(r'android:label=\"[^\"]*\"', 'android:label=\"${{ env.APP_NAME }}\"', content)
          with open('$MANIFEST', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "
          echo "âœ… App name set to: ${{ env.APP_NAME }}"

      # 5. ç¯å¢ƒä¿®å¤ (è§£å†³ Kotlin ç‰ˆæœ¬å†²çª)
      - name: Fix Android Environment
        run: |
          echo "ğŸ”§ Fixing Kotlin to 1.9.0..."
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          echo "ğŸ”§ Setting MinSDK to 24 (FFmpeg Kit è¦æ±‚)..."
          sed -i 's/minSdkVersion.*/minSdkVersion 24/g' android/app/build.gradle

      # 6. ğŸ’‰ã€å…³é”®ä¿®å¤ã€‘æ·»åŠ  FFmpeg Kit Maven ä»“åº“
      - name: Add FFmpeg Kit Repository
        run: |
          echo "ğŸ“¦ æ·»åŠ  arthenica Maven ä»“åº“..."
          
          # åœ¨ settings.gradle ä¸­æ·»åŠ ä»“åº“
          cat >> android/settings.gradle << 'EOF'
          
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
              repositories {
                  google()
                  mavenCentral()
                  maven { url 'https://github.com/AerunWeb/AerunWeb/raw/maven/' }
              }
          }
          EOF
          
          # åœ¨ build.gradle ä¸­æ·»åŠ ä»“åº“ (allprojects)
          cat >> android/build.gradle << 'EOF'
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  maven { url 'https://github.com/AerunWeb/AerunWeb/raw/maven/' }
              }
          }
          EOF
          echo "âœ… Maven ä»“åº“å·²æ·»åŠ "

      # 7. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: flutter pub get

      # 8. ç”Ÿæˆç­¾å
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 9. æ„å»º Release APK
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 10. é‡å‘½åå¹¶ä¸Šä¼ 
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Release
          path: "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"
