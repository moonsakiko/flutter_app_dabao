# ===============================
# 视频工坊 - GitHub Actions 云打包配置
# ===============================

name: Flutter Build APK
on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  APP_NAME: "视频工坊"
  FILE_NAME: "VideoCutter"

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      LANG: "en_US.UTF-8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 【关键】使用 ffmpeg_kit_flutter 插件（最可靠方案）
      # 不再尝试下载独立二进制，直接使用 Flutter 插件
      - name: Prepare FFmpeg (Plugin Mode)
        run: |
          echo "� 使用 ffmpeg_kit_flutter 插件方案..."
          mkdir -p assets/bin
          
          # 创建占位符文件（实际 FFmpeg 由插件提供）
          echo "# FFmpeg will be provided by ffmpeg_kit_flutter plugin" > assets/bin/README.txt
          
          echo "✅ FFmpeg 准备完成 (使用插件模式)"

      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            flutter create . --platforms android --project-name video_cutter
          fi

      - name: Change App Name and Permissions
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          # 修改 APP 名称
          sed -i 's/android:label="[^"]*"/android:label="视频工坊"/g' "$MANIFEST"
          
          # 添加存储权限 (如果不存在)
          if ! grep -q "READ_EXTERNAL_STORAGE" "$MANIFEST"; then
            sed -i 's/<application/<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"\/>\n    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO"\/>\n    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO"\/>\n\n    <application/g' "$MANIFEST"
          fi
          
          # 添加 requestLegacyExternalStorage (Android 10 兼容)
          if ! grep -q "requestLegacyExternalStorage" "$MANIFEST"; then
            sed -i 's/<application/<application android:requestLegacyExternalStorage="true"/g' "$MANIFEST"
          fi
          
          echo "✅ AndroidManifest.xml 已更新"

      - name: Fix Android Environment
        run: |
          # 修复 Kotlin 版本
          sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.0"/g' android/settings.gradle
          sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          # 修复 minSdkVersion (ffmpeg_kit 需要 24+)
          # 使用更精确的替换，避免破坏 flutter.xxx 变量引用
          sed -i 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 24/g' android/app/build.gradle
          sed -i 's/minSdk = flutter.minSdkVersion/minSdk = 24/g' android/app/build.gradle
          
          # 如果是旧格式，也处理
          sed -i 's/minSdkVersion 21/minSdkVersion 24/g' android/app/build.gradle
          sed -i 's/minSdkVersion 16/minSdkVersion 24/g' android/app/build.gradle
          
          echo "✅ Android 环境已修复"
          echo "--- build.gradle 内容 ---"
          cat android/app/build.gradle | head -50

      - name: Install Dependencies
        run: flutter pub get

      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      - name: Check APK Size
        run: |
          SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-release.apk)
          echo "APK size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          if [ "$SIZE" -lt 5000000 ]; then
            echo "⚠️ APK 太小，可能有问题"
          else
            echo "✅ APK 大小正常"
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Release
          path: build/app/outputs/flutter-apk/app-release.apk
