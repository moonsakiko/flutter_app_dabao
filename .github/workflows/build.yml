# ==============================
# Flutter è§†é¢‘æ— æŸå‰ªåˆ‡/åˆå¹¶ äº‘æ‰“åŒ…è„šæœ¬
# ==============================
name: Flutter Build Release
on:
  push:  # æ¯æ¬¡æ¨é€ä»£ç è‡ªåŠ¨è¿è¡Œ
    branches: [main, master]
  workflow_dispatch: # ä¹Ÿä¿ç•™æ‰‹åŠ¨è§¦å‘

# ğŸ‘‡ ç”¨æˆ·è‡ªå®šä¹‰é…ç½®åŒº (è¯·åœ¨æ­¤å¤„ä¿®æ”¹å‚æ•°)
env:
  # APP ä¸­æ–‡åï¼ˆå®‰è£…åæ˜¾ç¤ºçš„åç§°ï¼‰
  APP_LABEL: "æ— æŸå‰ªè¾‘"
  # ä¸‹è½½åŒ…åï¼ˆè‹±æ–‡ï¼Œé¿å…ä¹±ç ï¼‰
  FILE_NAME: "video_lossless_cutter"
  # å†…éƒ¨é¡¹ç›®åï¼ˆå¿…é¡»è‹±æ–‡+ä¸‹åˆ’çº¿ï¼‰
  PROJECT_NAME: "video_lossless_cutter"

jobs:
  build:
    runs-on: ubuntu-latest
    
    # è®¾ç½® UTF-8 ç¯å¢ƒï¼ˆé¿å…ä¸­æ–‡ä¹±ç ï¼‰
    env:
      LANG: "en_US.UTF-8"

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. é…ç½® Java 17
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. é…ç½® Flutter 3.19
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 4. ç”Ÿæˆ Android å·¥ç¨‹éª¨æ¶
      - name: Create Android Project
        run: |
          if [ ! -d "android" ]; then
            echo "âš™ï¸ Generating Android project scaffold..."
            flutter create . --platforms android --project-name ${{ env.PROJECT_NAME }}
          fi

      # 5. ä¿®æ”¹ APP ä¸­æ–‡å
      - name: Change App Name (UTF-8 Safe)
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          python3 -c "
          import re
          with open('$MANIFEST', 'r', encoding='utf-8') as f:
              content = f.read()
          new_content = re.sub(r'android:label=\"[^\"]*\"', 'android:label=\"${{ env.APP_LABEL }}\"', content)
          with open('$MANIFEST', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "
          echo "âœ… App label changed to: ${{ env.APP_LABEL }}"

      - name: Fix Android Environment
        run: |
          echo "ğŸ”§ Fixing Kotlin Version to 1.9.0..."
          # å¼ºåˆ¶ä¿®æ”¹ settings.gradle æ’ä»¶å— (æ”¾å®½æ­£åˆ™ï¼Œå¹¶ç¡®ä¿ apply false)
          sed -i 's/id "org.jetbrains.kotlin.android" version .*/id "org.jetbrains.kotlin.android" version "1.9.0" apply false/g' android/settings.gradle
          
          # å¼ºåˆ¶ä¿®æ”¹æ ¹ç›®å½• build.gradle (æ”¾å®½æ­£åˆ™)
          sed -i "s/ext.kotlin_version.*/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          
          echo "ğŸ”§ Fixing MinSdkVersion to 24 and CompileSdkVersion to 34..."
          # ä¿®æ”¹ app/build.gradle
          # 1. æå‡ minSdkVersion åˆ° 24
          sed -i 's/minSdkVersion .*/minSdkVersion 24/g' android/app/build.gradle
          # 2. å¼ºåˆ¶æŒ‡å®š compileSdkVersion ä¸º 34
          sed -i 's/compileSdkVersion .*/compileSdkVersion 34/g' android/app/build.gradle
          # 3. å¼ºåˆ¶æŒ‡å®š targetSdkVersion ä¸º 34 (ç§»é™¤å¯¹ flutter.targetSdkVersion çš„ä¾èµ–ï¼Œé¿å… null æŠ¥é”™)
          sed -i 's/targetSdkVersion .*/targetSdkVersion 34/g' android/app/build.gradle
          
          # 4. ç§»é™¤ndkVersion (å¦‚æœå­˜åœ¨)ï¼Œè®© AGP è‡ªåŠ¨é€‰æ‹©
          sed -i '/ndkVersion/d' android/app/build.gradle

          echo "ğŸ”§ Injecting R8/Proguard rules..."
          echo "android.enableR8=true" >> android/gradle.properties

          echo "ğŸ”§ Forcing compileSdkVersion 34 for ALL projects (plugins included)..."
          # åœ¨ android/build.gradle æœ«å°¾è¿½åŠ é…ç½®ï¼Œå¼ºåˆ¶ä¿®æ”¹æ‰€æœ‰å­é¡¹ç›®çš„ compileSdkVersion
          # è§£å†³ï¼šAAPT2 aapt2 E ... Failed to load resources table in APK .../android-35/android.jar
          cat <<EOF >> android/build.gradle

          subprojects {
              project.configurations.all {
                  resolutionStrategy.eachDependency { details ->
                      if (details.requested.group == 'com.android.support' && !details.requested.name.contains('multidex')) {
                          details.useVersion "26.1.0"
                      }
                  }
              }
              afterEvaluate { project ->
                  if (project.hasProperty("android")) {
                      android {
                          compileSdkVersion 34
                      }
                  }
              }
          }
          EOF
          
          # åŒé‡ä¿é™©ï¼šæ£€æŸ¥ä¿®æ”¹ç»“æœ
          echo "=== android/build.gradle content (tail) ==="
          tail -n 20 android/build.gradle

      # 7. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: flutter pub get

      # 8. ç”Ÿæˆå›¾æ ‡ï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰
      - name: Generate App Icon
        run: |
          if [ -f "assets/images/icon.png" ]; then
            echo "ğŸ¨ Generating App Icon..."
            dart run flutter_launcher_icons || echo "âš ï¸ Icon generation skipped"
          fi

      # 9. äº‘ç«¯ç”Ÿæˆç­¾åï¼ˆä¸´æ—¶å¯†é’¥ï¼‰
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=VideoLosslessCutter, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 10. æ‰“åŒ… APKï¼ˆRelease + ARM64 æé™ç˜¦èº«ï¼‰
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 11. é‡å‘½åè¾“å‡ºæ–‡ä»¶
      - name: Rename Output
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"

      # 12. ä¸Šä¼  APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}_Release
          path: "build/app/outputs/flutter-apk/${{ env.FILE_NAME }}.apk"
